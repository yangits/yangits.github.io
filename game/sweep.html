<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æ‰«é›·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            user-select: none;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin: auto;
        }
        .level {
            max-width: 500px;
            margin-top: 10px;
            font-size: 30px;
        }
        .level button {
            width: 26%;
            height: 35px;
            font-size: 16px;
            line-height: 35px;
            border-radius: 10px;
        }
        .gameBox {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
        }
        .gameBox span {
            display: inline-block;
            background: lightblue;
            border: 1px solid rgb(129, 129, 129);
            border-radius: 0%;
            text-align: center;
            font-weight: 900;
            color: transparent;
        }
    </style>
</head>
<body>
    <div class="level">
        <button type="button" onclick="choice('åˆçº§')">åˆçº§</button>
        <button type="button" onclick="choice('ä¸­çº§')">ä¸­çº§</button>
        <button type="button" onclick="choice('é«˜çº§')">é«˜çº§</button>
    </div>
    <div class="gameBox"></div>
    <div class="info">
        å‰©ä½™é›·æ•°:<span class="residue"></span>&emsp;æ—¶é—´:<span class="tick"></span> S
    </div>
    <script>
        var screenwidth=window.innerWidth>=500?480:window.innerWidth-20;
        var gameBox = document.querySelector('.gameBox')
        var row, col, num,map,table;
        var color={
                '0': "transparent",
                '1': "blue",
                '2': "green",
                '3': "red",
                '4': "navy",
                '5': "maroon",
                '6': "teal",
                '7': "black",
                '8': "gray"};
        choice('ä¸­çº§')
        // 1ï¼Œæˆä¸€å¼ åœ°å›¾
        function SweepMap(r, c, num) {
            map = new Array(r);
            for (var i = 0; i < r; i++) {
                map[i] = new Array(c).fill(0)
            }
            var randomLocation = function () {
                var x = Math.floor(Math.random() * r)
                var y = Math.floor(Math.random() * c)
                if (map[x][y] !== 9) {
                    map[x][y] = 9
                } else {
                    randomLocation()
                }
            }
            for (var i = 0; i < num; i++) {
                randomLocation()
            }
            // ä½¿ç”¨å¾ªç¯ç»™é›·çš„è¾¹ä¸Šæ‰€æœ‰æ•° +1 , å·²ç»æ˜¯é›·çš„é™¤å¤–
            var plus = function (array, x, y) {
                if (x >= 0 && x < r && y >= 0 && y < c) {
                    if (array[x][y] !== 9) {
                        array[x][y] += 1
                    }
                }
            }
            for (var x = 0; x < map.length; x++) {
                for (var y = 0; y < map[0].length; y++) {
                    if (map[x][y] === 9) {
                        plus(map, x - 1, y - 1)
                        plus(map, x + 1, y - 1)
                        plus(map, x - 1, y)
                        plus(map, x + 1, y)
                        plus(map, x - 1, y + 1)
                        plus(map, x + 1, y + 1)
                        plus(map, x, y + 1)
                        plus(map, x, y - 1)
                    }
                }
            }
        }
        function writeHtml() {
            let html=""
            for (let i = 0; i <row; i++) {
                for (let j = 0; j < col; j++) {
                    html+='<span style="width:'+withspan+'px;height:'+withspan+'px;line-height:'+
                    withspan+'px;font-size: '+withspan/2+'px;" onclick="show('+i+','+j+',this)">'+map[i][j]+'</span>' 
                }
            }
            gameBox.innerHTML=html;
            table = gameBox.children;
        }
        // åˆ¤æ–­æ˜¯å¦èƒœåˆ©
       function changeClearMineNum() {
            if (clearMineNum === ((col * row) - num)) {
                var allNum = 0
                var stop = setInterval(function () {
                    var r = Math.floor(Math.random() * 256)
                    var g = Math.floor(Math.random() * 256)
                    table[allNum].style.background = `rgba(${r},${g},210,0.6)`
                    table[allNum].style.color="transparent";allNum++
                    if (allNum === table.length) {
                        clearInterval(stop);clearInterval(stopTime)
                        alert('ä½ æˆåŠŸå•¦~ï¼ï¼æ™šä¸Šåƒè‚‰~~ï¼')
                        initializeGame(row, col, num)
                    }
                }, 10)
            }
        }
        // 3ï¼Œæ‰«é›·è¿‡ç¨‹
        var clearMineNum = 0
        function makeWhite(x, y) {
            if (x < row && y < col && x >= 0 && y >= 0) {
                if (table[x*col+y].style.background !== 'white'&&table[x*col+y].innerText !== 'ğŸš©') {
                    table[x*col+y].style.color=color[table[x*col+y].innerText]
                    table[x*col+y].style.background = 'white'
                    clearMineNum++
                    if (table[x*col+y].innerText === '0') {
                        makeWhite(x - 1, y + 1)
                        makeWhite(x - 1, y - 1)
                        makeWhite(x - 1, y)
                        makeWhite(x + 1, y + 1)
                        makeWhite(x + 1, y - 1)
                        makeWhite(x + 1, y)
                        makeWhite(x, y + 1)
                        makeWhite(x, y - 1)
                    }else{
                        autoFlag(x, y) 
                    }
                }
            }
        }
        // è·å–å‘¨å›´æ ¼å­
        function getSurroundingCells(x, y) {
            const cells = [];
            const xy = [];
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < row && ny >= 0 && ny < col) {
                        if(table[nx * col + ny].style.background !== 'white'){cells.push(table[nx * col + ny]);}
                        if(table[nx * col + ny].innerText === 'ğŸš©'){xy.push([x, y]);}
                    }
                }
            }
            return [cells,xy];
        }
        // è‡ªåŠ¨æ’æ——é€»è¾‘
        function autoFlag(x, y) {
            const num = parseInt(table[x * col + y].innerText);
            if (isNaN(num) || num <= 0) return;
            [candidates,dxy] = getSurroundingCells(x, y);
            if (candidates.length === num) {
                candidates.forEach(c => {
                    c.innerText="ğŸš©";
                    c.style.color="black";
                });
            }
            if (dxy.length === num) {
                dxy.forEach(c => {
                    x=c[0];y=c[1]
                    makeWhite(x - 1, y + 1)
                    makeWhite(x - 1, y - 1)
                    makeWhite(x - 1, y)
                    makeWhite(x + 1, y + 1)
                    makeWhite(x + 1, y - 1)
                    makeWhite(x + 1, y)
                    makeWhite(x, y + 1)
                    makeWhite(x, y - 1)
                });
            }
        }
        // ç»™æ‰€æœ‰æ–¹å—ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æ˜¾ç¤ºæ•°å­—ï¼Œæˆ–è€… boom
        function show(x,y) {
            if (table[x*col+y].innerText !== '9') {
                makeWhite(x,y);autoFlag(x, y) 
                changeClearMineNum()
            } else{
                table[x*col+y].style.background = 'white'
                table[x*col+y].style.color= 'black'
                table[x*col+y].innerText = 'ğŸ’£'
                Num=0// è¿™é‡Œåšäº†ä¸ªå°åŠ¨ç”»ï¼Œå¤±è´¥çš„æ—¶å€™æ…¢æ…¢çš„æ˜¾ç¤ºé›·çš„ä½ç½®
                var over = setInterval(function () {
                    if (table[Num].innerText === '9' ||table[Num].innerText === 'ğŸš©') {
                        table[Num].style.background = 'white'
                        table[Num].style.color= 'black'
                        table[Num].innerText = 'ğŸ’£'
                    }
                    Num++
                    if (Num >= table.length) {
                        clearInterval(over);
                        clearInterval(stopTime);
                        alert('æ¸¸æˆå¤±è´¥');
                        initializeGame(row, col, num)
                    }
                }, 10)
            }
        }
        // 4ï¼Œæ¸…é™¤ç”»é¢ï¼Œç„¶åå†™å…¥æ–°çš„ç”»é¢
        var stopTime
        function initializeGame(row, col, num) {
            var residue = document.querySelector('.residue')
            residue.innerText = num
            var time = document.querySelector('.tick')
            time.innerText = 0
            var i = 1
            clearInterval(stopTime)
            stopTime = setInterval(function () {
                time.innerText = i++
            }, 1000)
            gameBox.innerHTML = ''
            clearMineNum = 0
            SweepMap(row, col, num)
            writeHtml()
        }
        function choice(level){
            if (level === 'åˆçº§') {
                row=9, col=9, num=10;
            } else if (level === 'ä¸­çº§') {
                row=16, col=16, num=40;
            } else if (level === 'é«˜çº§') {
                row=32, col=16, num=99;
            }
            withspan=screenwidth/col;
            initializeGame(row, col, num)
        }
    </script>
</body>
</html>